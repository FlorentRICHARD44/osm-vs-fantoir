<html>
<head>
<meta charset="UTF-8">
<title>FANTOIRs erronés</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/tablesorter/jquery.tablesorter.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/style_fantoir_errone_annule.css" type="text/css"/>
<link rel="stylesheet" href="css/menu.css" type="text/css"/>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>

<script>
	var menu_labels
	var commune_valide = false
	var osm_state
	function start(){
		$('body').css('cursor','progress');
		$('#wait_ajax').css('visibility','visible')
						.append($('<p>').append('Chargement des FANTOIRs erronés...'))
						.append($('<p>').append("(oui, c'est long)"));
		$.ajax({
			url: "fantoir_errone.py",
		})
		.done(function( data ){
			titre_bandeau = ' codes FANTOIR erronés'
			if (data.length == 1){
				titre_bandeau = ' code FANTOIR erroné'
			}
			$('#bandeau h1').append(data.length+titre_bandeau)
			$('#wait_ajax').css('visibility','hidden');

			$('body').css('cursor','default');

			url_map_org_part1 = 'http://www.openstreetmap.org/'
			url_map_fr_part1 = 'http://tile.openstreetmap.fr/'
			url_bano_part1 = 'http://tile.openstreetmap.fr/~cquest/leaflet/bano.html'
			url_edit_part1 = 'http://www.openstreetmap.org/edit?editor='
			delta = 0.0008

/*			url_listing_fantoir = './liste_brute_fantoir.html#insee='+$('#input_insee')[0].value
			add_map_link('table_infos_commune',url_listing_fantoir,'FANTOIR')
			$('#table_infos_commune').append($('<tr>').append($('<td>').addClass('cellule_intitule').append('Données OSM en date du')).append($('<td>').addClass('cellule_data').append(cache_hsnr[2])))
*/
			add_header('table_fantoir_errone',true)
			table = 'table_fantoir_errone'
			$('#'+table).append($('<tbody>'))
			for (l=0;l<data.length;l++){
				let [fantoir,
					nom,
					lon,
					lat,
					dept,
					commune] = data[l]
				insee = fantoir.substr(0,5)

				//Dept
				$('#'+table).append($('<tr>').attr('id',fantoir).append($('<td>').text(dept)))
				//Commune (INSEE)
				$('#'+table+' tr:last').append($('<td>').text(commune+' ('+insee+')'))


				//Code Fantoir
				$('#'+table+' tr:last').append($('<td>').addClass('cell_fantoir').text(fantoir))

				//Nom OSM
				$('#'+table+' tr:last').append($('<td>').text(nom))
				if (lon && lat){
					url_ol_part2 = '?zoom=18&lat='+lat+'&lon='+lon
					url_hash_coords = '18/'+lat+'/'+lon
					xleft	= lon-delta
					xright	= lon+delta
					ybottom	= lat-delta
					ytop	= lat+delta
				//visu
					add_map_link(table,url_map_org_part1+'#map='+url_hash_coords,'ORG')
					/*add_map_link(table,url_bano_part1+'#'+url_hash_coords,'BANO')*/
				//JOSM
					add_josm_link(table,xleft,xright,ybottom,ytop)
				//Fantoir
					add_map_link(table,'./index.html#insee='+insee,'Pifomètre ('+insee+')')
					add_map_link(table,'./liste_brute_fantoir.html#insee='+insee,'Fantoir brut ('+insee+')')
				}
			}

	    //Sticky headers : le tableau scrolle dans son contenant
	    $('#table_fantoir_errone').tablesorter({
	        widthFixed : true,
	        headerTemplate : '{content} {icon}', // Add icon for various themes
	        widgets: [ 'stickyHeaders', 'filter' ],
	        widgetOptions: {
	          stickyHeaders_attachTo : '#reponse'
	        }
	    });

		})
	};
	function check_url_for_insee(){
		pattern_insee = new RegExp('^[0-9][0-9abAB][0-9]{3}$')
		var res
		if (window.location.hash){
			if (window.location.hash.split('insee=')[1]){
				if (pattern_insee.test(window.location.hash.split('insee=')[1].split('&')[0])){
					res = window.location.hash.split('insee=')[1].split('&')[0]
				} else {
					alert(window.location.hash.split('insee=')[1].split('&')[0]+' n\'est pas un code INSEE de commune\n\nAbandon')
				}
			}
		}
		return res
	}
	function add_map_link(table,href,text){
		$('#'+table+' tr:last').append($('<td>')
									.append($('<a>')
									.attr('href',href)
									.attr('target','blank')
									.text(text)))	
	}
	function add_josm_link(table,xl,xr,yb,yt){
		$('#'+table+' tr:last').append($('<td>').addClass('zone-clic-josm')
									.attr('xleft',xl).attr('xright',xr).attr('ybottom',yb).attr('ytop',yt)
									.text('JOSM')
									.click(function(){
										srcLoadAndZoom = 'http://127.0.0.1:8111/load_and_zoom?left='+xl+'&right='+xr+'&top='+yt+'&bottom='+yb;
										$('<img>').appendTo($('#josm_target')).attr('src',srcLoadAndZoom);
										$(this).addClass('clicked');
									})
								)
	}
	function add_header(table,with_edit_and_map_links){
		$('#'+table).append($('<thead>').append($('<tr>').append($('<th>').append('Dept'))))
		$('#'+table+' tr').append($('<th>').append('Commune (code Insee)'))
		$('#'+table+' tr').append($('<th>').append('Code Fantoir erroné'))
		$('#'+table+' tr').append($('<th>').append('Voie OSM'))
		if (with_edit_and_map_links){
			$('#'+table+' tr').append($('<th>').attr('colspan','1').append('Carte'))
			$('#'+table+' tr').append($('<th>').attr('colspan','1').append('Édition'))
			$('#'+table+' tr').append($('<th>').attr('colspan','2').append('Voir la commune sur...'))
		}
	}

</script>
</head>
<body onload="start()">

	<header>
		<!--#include file="includes/menu.html" -->
	</header>
		
	<div id="bandeau">
		<div id="descriptif">
			<h1></h1>
			<h4>Liste des codes Fantoir trouvés dans OSM et inconnus du fichier Fantoir officiel. Ce sont souvent des codes erronés, à cause d'erreurs de frappe : minuscules, inversions de caratères, etc.</h4>
		</div>
		<div id="wait_ajax"></div>
	</div>

	<div id="reponse">
		<table id="table_fantoir_errone" class="tablesorter"></table>
	</div>

	<footer>
		<!--#include file="includes/footer.html" -->
	</footer>

	<div id="josm_target" style="visibility : hidden"></div>

</body>
</html>