<html>
<head>
<meta charset="UTF-8">
<title>Pifomètre</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<link rel="stylesheet" href="css/bulma/bulma.min.css" type="text/css"/>
<link rel="stylesheet" href="css/bulma/main.min.css" type="text/css"/>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/style_pifometre.css" type="text/css"/>
<link rel="stylesheet" href="css/menu.css" type="text/css"/>
<link rel="search" type="application/opensearchdescription+xml" title="Pifomètre BANO" href="opensearch.xml" />
<script>
    FILTRES = [["voie",true],
               ["lieu_dit",true],
               ["nom_integre",true],
               ["nom_a_integrer",true],
               ["avec_adresses",true],
               ["sans_adresses",true]]
    STATUS_FANTOIR = []
    DELTA = 0.0008

    function start(){
        $('#table_communes_voisines').css('visibility','hidden');
        $('#table_communes_voisines table tr td').empty()
                                                 .removeAttr('insee_cible')
                                                 .unbind('click');
        $.ajax({
            url: "labels_statut_fantoir.py"
        })
        .done(function( data ) {
            a_menus_labels = []
            for (c=0;c<data.length;c++){
                menu_labels = '<select>'
                id_label = 0
                for (i=0;i<data.length;i++){
                    if (c!=i){
                        menu_labels+='<option value='+data[i][0]+'>'+data[i][1]+'</option>'
                    } else {
                        menu_labels+='<option value='+data[i][0]+' selected>'+data[i][1]+'</option>'
                        id_label = data[i][0]
                    }
                }
                STATUS_FANTOIR.push('statut'+c)
                menu_labels+='</select>'
                a_menus_labels[id_label] = menu_labels
            }
        })
        check_josm_remote_control()
        insee = check_url_for_insee()
        if (insee){
            $('#input_insee').empty()
            $('#input_insee')[0].value = insee
            requete_pifometre()
        }
        $('#bouton_communes_voisines').click(function(){
            $('#table_communes_voisines').css('visibility','visible');
        })
        $('#table_communes_voisines > .fermer').click(function(){
            $('#table_communes_voisines').css('visibility','hidden');
        })
        update_csv_url()

        $('#bouton_refresh').click(function(event){
                                refresh();
                                event.stopPropagation();
                            })
                            .mouseover(function(event){
                                get_osm_state();
                                refresh_infobulle();
                                event.stopPropagation();
                            })
                            .mouseout(function(){
                                $('#refresh_infobulle').hide()
                            })
    };
    function refresh(){
        if (commune_valide == false){
            return 0;
        }
        $('body').css('cursor','progress');
        $('#wait_ajax').empty()
                       .css('visibility','visible') 
                       .append($('<span>').append('Mise à jour BANO en cours...'));
        $.ajax({
            url: "refresh.py?insee="+$('#input_insee')[0].value,
        })
        .done(function( data ){
            if (data == '1'){
                requete_pifometre();
            } else {
                alert('Problème lors de la mise à jour')
            }
            $('body').css('cursor','default');
            $('#wait_ajax').css('visibility','hidden');
        })
    }

    function update_filtres(){
        for (let i = 0; i < FILTRES.length; i++){
            FILTRES[i] = [FILTRES[i][0],$('#check_'+FILTRES[i][0]).is(':checked')]
        }
    }
    function reset_filtres(){
        for (let i = 0; i < FILTRES.length; i++){
            FILTRES[i] = [FILTRES[i][0],true]
        }
        $('#boutons-filtres input').prop('checked',true)
    }
    function active_menu_filtres(){
        $('#boutons-filtres input').click(function(){
            show_mask_lines()
            update_menu_filtres()
        })
    };
    function update_menu_filtres(){
        $('#boutons-filtres li span.control-label').each(function(){
            total = $('#table_pifometre tr.'+$(this).attr('critere')).length
            visible = $('#table_pifometre tr:visible.'+$(this).attr('critere')).length
            $(this).children('span').text(' ('+visible+' / '+total+')')
        })
    };
    function show_mask_lines(){
        update_filtres()
        $('#table_pifometre tbody tr').each(function() {
           action = 'donotfilter'
           for (let f of FILTRES){
                if ($(this).hasClass(f[0]) && f[1] == false){
                    action = 'filter'
                }
                $(this).removeClass('filtered')
                if (action == 'filter'){
                    $(this).addClass('filtered')
                }
            }
       });
    }

    function add_josm_link(xl,xr,yb,yt){
        $('#table_pifometre tr:last').append($('<td>')
                                    .addClass('zone-clic-josm')
                                    .attr('xleft',xl).attr('xright',xr).attr('ybottom',yb).attr('ytop',yt)
                                    .text('JOSM')
                                    .click(function(){
                                        srcLoadAndZoom = 'http://127.0.0.1:8111/load_and_zoom?left='+xl+'&right='+xr+'&top='+yt+'&bottom='+yb;
                                        $('<img>').appendTo($('#josm_target')).attr('src',srcLoadAndZoom);
                                        $(this).addClass('clicked');
                                    })
                                )
    }
    function add_statut_fantoir(id_ligne,fantoir,id_statut){
        $('#table_pifometre tr:last').removeClass(STATUS_FANTOIR).addClass('statut'+id_statut)
        $('#table_pifometre tr:last').append($('<td>').append($(a_menus_labels[id_statut]).change(function() {
            insee = fantoir.substr(0,5);
            statut = $(this)[0].value;
            $.ajax({
                url: "statut_fantoir.py?insee="+insee+"&fantoir="+fantoir+"&statut="+statut
            })
            .done(function( data ) {
                if(data == statut){
                    $('tr#'+id_ligne).removeClass(STATUS_FANTOIR).addClass('statut'+statut)
                } else {
                    alert("Souci lors de la mise à jour du statut. Le nouveau statut n'a pas été pris en compte")
                }
            })
        })))
    }
    function add_josm_addr_link(insee,fantoir,nom_fantoir,nombre,fantoir_dans_relation,is_place){
        $('#table_pifometre tr:last').append($('<td>'))
        $('#table_pifometre tr:last td:last').append($('<span>')
                                    .addClass('zone-clic-adresses')
                                    .text(nombre > 1 ? nombre+' Points':'1 Point')
                                    .click(function(){
                                        stringToRemove = window.location.href.split('/').pop()
                                        srcURL = 'http://127.0.0.1:8111/import?new_layer=true&layer_name='+nom_fantoir+'&url='+window.location.href.replace(stringToRemove,'')+'requete_numeros.py?insee='+insee+'&fantoir='+fantoir+'&modele='+((is_place) ? 'Place':'Points');
                                        $('<img>').appendTo($('#josm_target')).attr('src',srcURL);
                                        $(this).addClass('clicked');
                                    })
                                )
        if (is_place){
            $('#table_pifometre tr:last td:last').append($('<span>').text(' (lieu-dit)'))
        } else {
            $('#table_pifometre tr:last td:last').append($('<span>').text(' ou '))
            $('#table_pifometre tr:last td:last').append($('<span>')
                                        .addClass('zone-clic-adresses')
                                        .text('Relation')
                                        .click(function(){
                                            stringToRemove = window.location.href.split('/').pop()
                                            srcURL = 'http://127.0.0.1:8111/import?new_layer=true&layer_name='+nom_fantoir+'&url='+window.location.href.replace(stringToRemove,'')+'requete_numeros.py?insee='+insee+'&fantoir='+fantoir+'&modele=Relation&fantoir_dans_relation='+fantoir_dans_relation;
                                            $('<img>').appendTo($('#josm_target')).attr('src',srcURL);
                                            $(this).addClass('clicked');
                                        })
                                    )
        }
    }
    function add_addr_inspector_link(insee,fantoir,source){
        $('#table_pifometre tr:last')   .append($('<td>')
                                        .addClass('zone-clic-adresses')
                                        .append($('<a>').attr('href',"numeros.html?insee="+insee+'&fantoir='+fantoir+'&source='+source+'&tab=0').attr('target',"blank")
                                            .text('Qualifier')
                                        )
                                        .click(function(){
                                            $(this).addClass('clicked');
                                        })
                                        )
    };

    function requete_pifometre(){
        commune_valide = false;
        $('body').css('cursor','progress');
        $('#table_pifometre').trigger("destroy");
        $('#table_pifometre').empty()
        $('#input_insee')[0].value = $('#input_insee')[0].value.toUpperCase()
        $.ajax({
            url: "requete_pifometre_commune.py?insee="+$('#input_insee')[0].value
        })
        .done(function( pifodata ) {
            let [nom_commune,
                 lon_commune,
                 lat_commune,
                 communes_voisines,
                 insee_commune_parente,
                 nom_commune_parente,
                 date_dernier_rapprochement,
                 commune_composee] = pifodata

            document.title = nom_commune+' - Pifomètre'
            $('#infos_commune').empty()
            $('#alerte_commune').css('visibility','hidden');

            if (nom_commune.length == 0){
                $('#infos_commune').append($('<h2>').append('INSEE '+$('#input_insee')[0].value+' : commune inconnue'))
                $('body').css('cursor','default');
                return 0;
            }
            commune_valide = true;
            $('#wait_ajax').empty()
                           .css('visibility','visible')
                           .append($('<span>').append('Chargement des données...'));


            url_map_org_part1 = 'http://www.openstreetmap.org/'
            url_bano_part1 = 'http://tile.openstreetmap.fr/~cquest/leaflet/bano.html'
            url_edit_part1 = 'http://www.openstreetmap.org/edit?editor='
            delta = 0.0008
            url_hash_coords = '15/'+lat_commune+'/'+lon_commune
            url_listing_fantoir = './liste_brute_fantoir.html#insee='+$('#input_insee')[0].value

            $('#infos_commune').append($('<div id="infos_commune_col1">')
                                    .append($('<div id="date-maj">')
                                        .append($('<div>').addClass('cellule_intitule').append('<strong>Dernier rapprochement le</strong>'))
                                        .append($('<div>').addClass('cellule_data').append('&nbsp;').append(date_dernier_rapprochement).append(' (UTC)<br/>'))
                                    )
                                    .append($('<div id="liens_commune">').append('<strong>Voir la commune sur :</strong> ')
                                        .append($('<a>')
                                            .attr('target','blank')
                                            .attr('href',url_map_org_part1+'?mlat='+lat_commune+'&mlon='+lon_commune+'#map='+url_hash_coords)
                                            .text('ORG')
                                        )
                                        .append(' / ')
                                        .append($('<a>')
                                            .attr('target','blank')
                                            .attr('href',url_bano_part1+'#'+url_hash_coords)
                                            .text('BANO')
                                        )
                                        .append(' / ')
                                        .append($('<a>')
                                            .attr('target','blank')
                                            .attr('href',url_listing_fantoir)
                                            .text('FANTOIR')
                                        )
                                    )
                                )

            $('#infos_commune').append($('<div id="titre_commune">').append($('<h1>').append((nom_commune))))

            //communes voisines
            $('#table_communes_voisines tr td').empty()
            $('#table_communes_voisines tr td.commune_centre').text(nom_commune)
            for (v in communes_voisines){
                $('#table_communes_voisines tr td#'+(communes_voisines[v])[0]).text(communes_voisines[v][2]).attr('insee_cible',communes_voisines[v][1]).addClass('lien_commune')
                    .click(function(){
                    location.assign(window.location.href.split('#')[0]+'#insee='+$(this).attr('insee_cible'))
                    start()
                })
            }
            if (insee_commune_parente){
                $('#alerte_commune').empty();
                $('#alerte_commune').css('visibility','visible');
                $('#alerte_commune').append($('<div>').addClass('fermer-alerte').text('X'))
                $('#alerte_commune > .fermer-alerte').click(function(){
                    $('#alerte_commune').css('visibility','hidden');
                })
/*                $('#alerte_commune').append($('<h3>').text(nom_commune+' est une ancienne commune. Elle a été incorporée dans ').append($('<a>').attr('href','#insee='+insee_commune_parente).text(nom_commune_parente+'('+insee_commune_parente+')')))
*/
                $('#alerte_commune').append($('<p>').text(nom_commune+' est une ancienne commune. Elle a été incorporée dans ').append($('<span>').addClass('lien_commune').text(nom_commune_parente+' ('+insee_commune_parente+')')).attr('insee_cible',insee_commune_parente)
                    .click(function(){
                        location.assign(window.location.href.split('#')[0]+'#insee='+$(this).attr('insee_cible'))
                        start()
                    }))
            }
            $.ajax({
                url: "requete_pifometre_voies.py?insee="+$('#input_insee')[0].value
            })
            .done(function( data ) {
                reset_filtres()
                $('#table_pifometre').append($('<thead>').append($('<tr>').append($('<th>').append('Code FANTOIR'))))
                if (commune_composee == 1){
                    $('#table_pifometre tr').append($('<th>').append('Ancienne commune'))
                }
                $('#table_pifometre tr').append($('<th>').append('Libellé TOPO'))
                $('#table_pifometre tr').append($('<th>').append('Libellé OSM'))
                $('#table_pifometre tr').append($('<th>').append('Libellé BAN ou CADASTRE'))
                $('#table_pifometre tr').append($('<th>').append('Edition'))
                $('#table_pifometre tr').append($('<th>').append('Statut FANTOIR ').append($('<a>').attr('href','http://wiki.openstreetmap.org/wiki/Contribuer_%C3%A0_la_BANO#Typologie_des_anomalies_FANTOIR').append('(wiki)')))
                $('#table_pifometre tr').append($('<th>').addClass('string-none').append('Intégrer les adresses'))
                $('#table_pifometre tr').append($('<th>').append('Qualifier les adresses'))
                $('#table_pifometre').append($('<tbody>'))
                tr_id = 1000
                for (s=0;s<data.length;s++){
                    let [fantoir,
                         annule,
                         nom_topo,
                         nom_osm,
                         nom_ban,
                         nom_ancienne_commune,
                         lon,
                         lat,
                         statut_voie,
                         numeros_a_proposer,
                         caractere_annul,
                         is_place,
                         avec_adresses_ban] = data[s]
                    fantoir_affiche = fantoir
                    fantoir_dans_relation = 'ok'
                    if (caractere_annul == 'B'){
                        fantoir_affiche = 'Voie sans FANTOIR'
                        fantoir_dans_relation = 'ko'
                    }

                    tr_id+=1

                    $('#table_pifometre tbody').append($('<tr>').attr('id',tr_id).append($('<td>').attr('fantoir',fantoir).addClass('cell_fantoir').text(fantoir_affiche)))
                    if (annule == -1){
                        $('#table_pifometre tr:last td:last').addClass('annule').attr('title','FANTOIR annulé, à remplacer dans OSM')
                    }
                    //Ajout des classes pour les filtres à chaque ligne
                    if (is_place){
                        $('#table_pifometre tr:last').addClass('lieu_dit')
                    } else {
                        $('#table_pifometre tr:last').addClass('voie')
                    }
                    if (nom_osm == undefined) {
                        $('#table_pifometre tr:last').addClass('nom_a_integrer')
                    } else {
                        $('#table_pifometre tr:last').addClass('nom_integre')
                    } 
                    if (avec_adresses_ban) {
                        $('#table_pifometre tr:last').addClass('avec_adresses')
                    } else {
                        $('#table_pifometre tr:last').addClass('sans_adresses')
                    }

                    //Remplissage des cellules avec leur contenu

                    // Nom de l'ancienne commune
                    if (commune_composee == 1){
                        $('#table_pifometre tr:last').append($('<td>').text(nom_ancienne_commune))
                    }
                    //Nom Fantoir
                    $('#table_pifometre tr:last').append($('<td>').text(nom_topo))
                    //Nom OSM
                    if ($('#table_pifometre tr:last').hasClass('nom_integre')){
                        $('#table_pifometre tr:last').append($('<td>')
                                                        .append($('<span class="pastille-verte">'))
                                                        .append($('<span>').text(nom_osm)))
                    }
                    else {
                        $('#table_pifometre tr:last').append($('<td>')
                                                        .append($('<span class="pastille-orange">'))
                                                        .append($('<span>').text(nom_osm)))
                    }
                    //Nom BAN
                    $('#table_pifometre tr:last').append($('<td>').text(nom_ban))
                    xmin  = lon-DELTA
                    xmax  = lon+DELTA
                    ymin  = lat-DELTA
                    ymax  = lat+DELTA
                    //visu
    //                add_map_link(table,url_map_org_part1+'#map='+url_hash_coords,'ORG')
                    //JOSM
                    if (lon != undefined) {
                        add_josm_link(xmin,xmax,ymin,ymax)
                    } else {
                        $('#table_pifometre tr:last').append($('<td>'))
                    }
                    //Statut FANTOIR
                    add_statut_fantoir(tr_id,fantoir,statut_voie)
                    //Adresses à integrer
                    if (numeros_a_proposer > 0){
                        add_josm_addr_link($('#input_insee')[0].value,fantoir,nom_topo,numeros_a_proposer,fantoir_dans_relation,is_place)
                    } else {
                        $('#table_pifometre tr:last').append($('<td>'))
                    }
                    if (avec_adresses_ban){
                        add_addr_inspector_link($('#input_insee')[0].value,fantoir,'BAN')
                    } else {
                        $('#table_pifometre tr:last').append($('<td>'))
                    }
                }
                $('#wait_ajax').css('visibility','hidden');

                //Sticky headers : le tableau scrolle dans son contenant
                $('#table_pifometre').tablesorter({
                    widthFixed : true,
                    headerTemplate : '{content} {icon}', // Add icon for various themes
                    widgets: [ 'stickyHeaders', 'filter' ],
                    widgetOptions: {
                      stickyHeaders_attachTo : '#reponse'
                    }
                });

                active_menu_filtres()
                update_menu_filtres()
            })
            window.location.hash="#insee="+$('#input_insee')[0].value
            $('body').css('cursor','default');
        })
    };

    function add_header(){
        $('#table_pifometre').append($('<thead>').append($('<tr>').append($('<th>').append('Code FANTOIR'))))
        $('#table_pifometre tr').append($('<th>').append('Création TOPO'))
        $('#table_pifometre tr').append($('<th>').append('Libellé TOPO'))
        $('#table_pifometre tr').append($('<th>').append('Libellé OSM'))
        $('#table_pifometre tr').append($('<th>').append('Libellé BAN ou CADASTRE'))
        $('#table_pifometre tr').append($('<th>').append('Edition'))
        $('#table_pifometre tr').append($('<th>').append('Statut FANTOIR ').append($('<a>').attr('href','http://wiki.openstreetmap.org/wiki/Contribuer_%C3%A0_la_BANO#Typologie_des_anomalies_FANTOIR').append('(wiki)')))
        $('#table_pifometre tr').append($('<th>').addClass('string-none').append('Intégrer les adresses'))
        $('#table_pifometre tr').append($('<th>').append('Qualifier les adresses'))
        $('#table_pifometre').append($('<tbody>'))
    };
    function check_url_for_insee(){
        pattern_insee = new RegExp('^[0-9][0-9abAB][0-9]{3}$')
        var res
        if (window.location.hash){
            if (window.location.hash.split('insee=')[1].split('&')[0]){
                if (pattern_insee.test(window.location.hash.split('insee=')[1].split('&')[0])){
                    res = window.location.hash.split('insee=')[1].split('&')[0]
                } else {
                    alert(window.location.hash.split('insee=')[1].split('&')[0]+' n\'est pas un code INSEE de commune\n\nAbandon')
                }
            }
        }
        return res
    }
    function update_csv_url(){
        urlCSV = 'requete_pifometre.py?insee='+$('#input_insee')[0].value+'&format=csv';
        /*$('#bouton_export_csv').empty()
        $('#bouton_export_csv').append($('<a>').attr('href',"requete_pifometre.py?insee="+$('#input_insee')[0].value+'&format=csv')
                                               .attr('target','blank'))*/
    }

    function add_map_link(table,href,text){
        $('#'+table+' tr:last').append($('<td>')
                                    .append($('<a>')
                                    .attr('href',href)
                                    .attr('target','blank')
                                    .text(text)))
    }
    function get_osm_state(){
        $.ajax({
            url: "osm_state.py",
            async:false
        })
        .done(function( data ){
            osm_state = data;
        })
    }
    function refresh_infobulle(){
        $('#refresh_infobulle').empty()
                            .append('Mettre à jour avec les données OSM du ')
                            .append($('<span>').append(osm_state+' (UTC)'))
                            .show()
    }
    function check_josm_remote_control(){
        $.ajax({
            url: "http://127.0.0.1:8111/version"
        })
        .done(function(data){
            if (data){
                console.log('Telecommande JOSM OK')
            }
        })
        .fail(function(data){
            alert("La telecommande JOSM ne répond pas.\nCertains liens sur la page nécessitent que JOSM soit démarré avec la télécommande activée\n\nPour de l'aide sur la télécommande : https://josm.openstreetmap.de/wiki/Help/Preferences/RemoteControl")
        })
    }

</script>
</head>

<body onload="start()">
    <header>
        <!--#include file="includes/menu.html" -->
    </header>

    <div id="barre-jaune">
        <span>Commune :</span>
        <form action="javascript:requete_pifometre()" autocomplete="on">
            <input type="text" id="input_insee" placeholder="Code INSEE"></input>
            <input type="submit" value="Lister">
        </form>
    </div>

    <div id="bandeau">
        <div id="infos_commune"></div>
        <div id="refresh_infobulle"></div>
        <div id="table_communes_voisines">
            <div class="fermer">X</div>
            <table>
            <tbody>
                <tr><td id="11"></td><td id="12"></td><td id="1"></td><td id="2"></td></tr>
                <tr><td id="10"></td><td class="commune_centre" colspan="2" rowspan="2"></td><td id="3"></td></tr>
                <tr><td id="9"></td><td id="4"></td></tr>
                <tr><td id="8"></td><td id="7"></td><td id="6"></td><td id="5"></td></tr>
            </tbody>
            </table>
        </div>
        <button id="bouton_communes_voisines" title="Communes voisines"></button>
        <button id="bouton_refresh"></button>
        <button id="bouton_export_csv" title="Exporter l'onglet courant en CSV" onclick="window.open(urlCSV, '_blank');"></button>
        <div id="infos_refresh"></div>
        <div id="alerte_commune"></div>
        <div id="wait_ajax"></div>

        <div id="boutons-filtres">
            <div id="ligne-afficher">
                <p><strong>Afficher :</strong></p>
            </div>
            <div id="ligne-boutons-filtres">
                <div>
                    <ul>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_voie" checked>
                            <span class="check is-dark"></span>
                            <span class="control-label" critere="voie">Voies<span></span></span>
                        </li>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_lieu_dit" checked>
                            <span class="check is-dark"></span>
                            <span class="control-label" critere="lieu_dit">Lieux-dits<span></span></span>
                        </li>
                    </ul>
                </div>
                <div>
                    <ul>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_nom_integre" checked>
                            <span class="check is-green"></span>
                            <span class="control-label" critere="nom_integre">Déjà rapproché(e)s dans OSM<span></span></span>
                        </li>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_nom_a_integrer" checked>
                            <span class="check is-orange"></span>
                            <span class="control-label" critere="nom_a_integrer">Pas encore rapproché(e)s dans OSM<span></span></span>
                        </li>
                    </ul>
                </div>
                <div>
                    <ul>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_avec_adresses" checked>
                            <span class="check is-purple"></span>
                            <span class="control-label" critere="avec_adresses">Ayant des adresses référencées dans la BAN<span></span></span>
                        </li>
                        <li>
                            <label class="switch is-rounded is-small">
                            <input type="checkbox" id="check_sans_adresses" checked>
                            <span class="check is-dark"></span>
                            <span class="control-label" critere="sans_adresses">Sans adresses<span></span></span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="reponse">
        <table id="table_pifometre"></table>
    </div>
    <footer>
    <!--#include file="includes/footer.html" -->
    </footer>
    <div id="josm_target" style="visibility : hidden"></div>
</body>
</html>