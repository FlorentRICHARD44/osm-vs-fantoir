<html>
<head>
<meta charset="UTF-8">
<title>Qualification des numéros d'adresses BAN</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/tablesorter/jquery.tablesorter.js"></script>
<script src="js/jquery.tablesorter.combined.min.js"></script>
<script src="js/fonctions.js"></script>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/responsive.css" type="text/css"/>
<!-- leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
<script>
    var menu_labels
    function check_url_for_fantoir(){
        pattern_fantoir = new RegExp('^[0-9][0-9abAB][0-9]{3}[0-9|a-z|A-Z]{4}$')
        var res
        if (window.location.search){
            if (window.location.search.split('fantoir=')[1].split('&')[0]){
                if (pattern_fantoir.test(window.location.search.split('fantoir=')[1].split('&')[0])){
                    res = window.location.search.split('fantoir=')[1].split('&')[0]
                } else {
                    alert(window.location.search.split('fantoir=')[1].split('&')[0]+' n\'est pas un code FANTOIR valide\n\nAbandon')
                }
            }
        }
        return res
    }
    function check_url_for_source(){
        var res
        res = ""
        if (window.location.search){
            if (window.location.search.split('&source=')[1]){
                if (window.location.search.split('source=')[1].split('&')[0]){
                    res = window.location.search.split('source=')[1].split('&')[0]
                }
            }
        }
        return res
    }

    function add_josm_addr_link(insee,fantoir,nom_fantoir,nombre,fantoir_dans_relation,is_place){
        //Nb de points
        $('#liens_voie').append($('<span>').addClass('zone-clic-adresses')
                            .append($('<span>').text(nombre > 1 ? nombre+' Points':'1 Point'))
                        )
        if (is_place){
            $('#liens_voie .zone-clic-adresses').append($('<span>').text(' (lieu-dit)'))
        }
        //Ajouter lien
        $('#liens_voie .zone-clic-adresses').click(function(){
                                                stringToRemove = window.location.href.split('/').pop()
                                                srcURL = 'http://127.0.0.1:8111/import?new_layer=true&layer_name='+nom_fantoir+'&url='+window.location.href.replace(stringToRemove,'')+'requete_numeros.py?insee='+insee+'&fantoir='+fantoir+'&modele='+((is_place) ? 'Place':'Points');
                                                $('<img>').appendTo($('#josm_target')).attr('src',srcURL);
                                            })
        //Ou relation si c'est une voie
        if (!is_place){
            $('#liens_voie').append($('<span>').text(' ou '))
            $('#liens_voie').append($('<span>').addClass('zone-clic-adresses').text('Relation')
                                                .click(function(){
                                                    stringToRemove = window.location.href.split('/').pop()
                                                    srcURL = 'http://127.0.0.1:8111/import?new_layer=true&layer_name='+nom_fantoir+'&url='+window.location.href.replace(stringToRemove,'')+'requete_numeros.py?insee='+insee+'&fantoir='+fantoir+'&modele=Relation&fantoir_dans_relation='+fantoir_dans_relation;
                                                    $('<img>').appendTo($('#josm_target')).attr('src',srcURL);
                                                })
                                    )
        }
    }

    function add_statut_numero(id_ligne,numero,statut,insee,fantoir){
        $('#table_inspect_adresse tr:last').removeClass().addClass('statut'+statut).attr('numero',numero)
        $('#table_inspect_adresse tr:last').append($('<td>').append($(a_menus_labels[statut]).change(function() {
            statut = $(this)[0].value;
            $.ajax({
                url: "statut_numero.py?insee="+insee+"&fantoir="+fantoir+"&statut="+statut+"&numero="+numero+"&source=BAN"
            })
            .done(function( data ) {
                if(data == statut){
                    $('tr#'+id_ligne).removeClass().addClass('statut'+statut);

                    //Afficher l'infobulle de confirmation
                    if (statut != '0') {
                        $('tr#'+id_ligne+' td:last').append($('<span class="enregistrement numeros rose">').text('✔ Enregistré'));
                    }
                    else {
                        $('tr#'+id_ligne+' td:last').append($('<span class="enregistrement numeros bleu">').text('✔ Enregistré'));
                    }
                    setTimeout(function(){
                        $('tr#'+id_ligne+' td:last span').css('opacity', '1');
                        setTimeout(function(){
                            $('tr#'+id_ligne+' td:last span').css('opacity', '0');                      
                        }, 1500);
                        setTimeout(function(){
                            $('tr#'+id_ligne+' td:last span').remove();                
                        }, 2000);
                    }, 50);

                } else {
                    alert("Souci lors de la mise à jour du statut. Le nouveau statut n'a pas été pris en compte")
                }
                refresh();
            })
        })))
    }
    function start(){
        $.ajax({
            url: "labels_statut_numero.py"
        })
        .done(function( data ) {
            a_menus_labels = []
            for (c=0;c<data.length;c++){
                menu_labels = '<select>'
                id_label = 0
                for (i=0;i<data.length;i++){
                    if (c!=i){
                        menu_labels+='<option value='+data[i][0]+'>'+data[i][1]+'</option>'
                    } else {
                        menu_labels+='<option value='+data[i][0]+' selected>'+data[i][1]+'</option>'
                        id_label = data[i][0]
                    }
                }
                menu_labels+='</select>'
                a_menus_labels[id_label] = menu_labels
            }
        })

        insee = check_url_for_insee()
        fantoir = check_url_for_fantoir()
        source = check_url_for_source()

        $.ajax({
            url: "requete_inspect_numeros.py?insee="+insee+"&fantoir="+fantoir
        })
        .done(function( data ) {
                                let[nom_fantoir,
                                    is_place,
                                    numeros_a_proposer,
                                    nom_commune,
                                    nom_voie] = data[0]
                                data = data[1]
                                min_lon = data[0][1] == undefined ? data[0][4]:data[0][1];
                                max_lon = min_lon;
                                min_lat = data[0][2] == undefined ? data[0][5]:data[0][2];
                                max_lat = min_lat;

                                var map = L.map('map').setView([min_lat, min_lon], 18);
                                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom: 19}).addTo(map);

                                // INFOS 1e COLONNE : Liens commune, intégration adresses
                                $('#infos_commune_col1').empty()
                                                    .append($('<div id="date-maj">')
                                                      .append($('<div>').addClass('cellule_intitule').append('<strong>Code Insee :</strong>'))
                                                      .append($('<div>').addClass('cellule_data').append('&nbsp;').append(insee))
                                                    )
                                .append($('<div id="liens_commune">').append('<strong>Voir la commune sur :</strong> ')
                                  /*.append($('<a>')
                                      .attr('target','blank')
                                      .attr('href',url_map_org_part1+'?mlat='+lat_commune+'&mlon='+lon_commune+'#map='+url_hash_coords)
                                      .text('ORG')
                                  )
                                  .append(' / ')*/
                                  .append($('<a>')
                                      .attr('target','blank')
                                      .attr('href','https://adresse.data.gouv.fr/base-adresse-nationale/'+insee)
                                      .text('BAN')
                                  )
                                  .append(' / ')
                                  .append($('<a>')
                                      .attr('target','blank')
                                      .attr('href','index.html#insee='+insee)
                                      .text('Pifomètre')
                                  )
                                )

                                .append($('<div id="liens_voie">').append('<strong>Intégrer les adresses :</strong> '))

                                // INFOS 2e COLONNE : Nom voie, type voie, commune
                                $('#infos_commune_col2 h2').empty().append(nom_commune)
                                $('#infos_commune_col2 h1').empty().append(nom_voie)
                                
                                if (is_place==true){
                                   $('#infos_commune_col2 h1').append(' (lieu-dit)')
                                } else {
                                   $('#infos_commune_col2 h1').append(' (voie)')
                                }

                                if (numeros_a_proposer > 0){
                                    add_josm_addr_link(insee,fantoir,nom_fantoir,numeros_a_proposer,true,is_place)
                                } else {
                                    $('#liens_voie').append($('<span>').addClass('adresses-integrees').text('✔'))
                                                        .append($('<span>').text(' Adresses intégrées'))
                                }
                                $('#table_inspect_adresse').empty().append($('<thead>').append($('<tr>').append($('<th>').append('Numéro'))))
                                $('#table_inspect_adresse tr').append($('<th>').append('Intégration ?'))
                                $('#table_inspect_adresse tr').append($('<th>').append('Statut de l\'adresse BAN'))
                                $('#table_inspect_adresse').append($('<tbody>'))
                                for (l=0;l<data.length;l++){
                                    let[numero,
                                        lon_ban,
                                        lat_ban,
                                        statut,
                                        lon_osm,
                                        lat_osm] = data[l]

                                    $('#table_inspect_adresse tbody:last').append($('<tr>').attr('id',l).append($('<td>').text(numero)))
                                    if (lon_ban != undefined && lon_osm != undefined){
                                        $('#table_inspect_adresse tr:last').append($('<td>').text('vert'));
                                    } else if (lon_ban != undefined){
                                        $('#table_inspect_adresse tr:last').append($('<td>').text('orange'));
                                    } else if (lon_osm != undefined){
                                        $('#table_inspect_adresse tr:last').append($('<td>').text('bleu'));
                                    }

                                    add_statut_numero(l,numero,statut,insee,fantoir)

                                    if (lon_ban != undefined){
                                        var myIcon = L.divIcon({className: 'map-numero ligne'+l,html:'<span>'+numero+'</span>'});
                                        L.marker([lat_ban, lon_ban],{icon: myIcon}).addTo(map)
                                        min_lon = Math.min(min_lon,lon_ban);
                                        max_lon = Math.max(max_lon,lon_ban);
                                        min_lat = Math.min(min_lat,lat_ban);
                                        max_lat = Math.max(max_lat,lat_ban);
                                    }
                                    if (lon_osm != undefined){
                                        var myIcon = L.divIcon({className: 'map-numero ligne'+l,html:'<span>'+numero+' oSM </span>'});
                                        L.marker([lat_osm, lon_osm],{icon: myIcon}).addTo(map)
                                        min_lon = Math.min(min_lon,lon_osm);
                                        max_lon = Math.max(max_lon,lon_osm);
                                        min_lat = Math.min(min_lat,lat_osm);
                                        max_lat = Math.max(max_lat,lat_osm);
                                    }
                                    $('#table_inspect_adresse tr:last').hover(function() {
                                        $('.map-numero.ligne'+$(this).attr('id')).addClass('numero-over')},
                                        function() {
                                            $('.map-numero.ligne'+$(this).attr('id')).removeClass('numero-over')});
                                }
                                $('#table_inspect_adresse').trigger("resetToLoadState");
                                
                                //Sticky headers : le tableau scrolle dans son contenant
                                $('#table_inspect_adresse').tablesorter({
                                    widthFixed : true,
                                    headerTemplate : '{content} {icon}', // Add icon for various themes
                                    widgets: [ 'stickyHeaders', 'filter' ],
                                    widgetOptions: {
                                      stickyHeaders_attachTo : '#reponse_numeros'
                                    }
                                });

                                map.fitBounds([[min_lat,min_lon],[max_lat,max_lon]]);

                                refresh();
                            })
    }

    function refresh(){
        $('.map-numero').removeClass('anomalie');
        for (i=1;i<a_menus_labels.length;i++){
            $('.statut'+i).each(function(){
                $('.map-numero.ligne'+$(this).attr('id')).addClass('anomalie')
            })
        }
    }
    
</script>
<style>
        .numero-over {color: red;}
</style></head>

<body onload="start()">

    <header>
        <!--#include file="includes/menu.html" -->
    </header>

    <div id="barre-jaune">
        <span>> Qualification des anomalies des numéros d'adresse</span>
    </div>

    <div id="bandeau">
        <div id="descriptif">
            <div id="infos_commune_col1"></div>
            <div id="infos_commune_col2">
                <h2></h2>
                <h1></h1>
            </div>
        </div>
<!--         <div id="descriptif_col1">
            <h2></h2>
            <h1></h1>
        </div>
        <div id="descriptif_col2">
            <h3 id="integration"></h3>
            <h2 id="type_voie"></h2>
        </div> -->
    </div>

    <div id="reponse_numeros">
        <table id="table_inspect_adresse"></table>
    </div>
     <div id="map"></div>
     <div id="legende_map">
         <p><span class="legende-numero integre">Vert</span> : ✔ Adresses intégrées dans OSM (bientôt disponible)</p>
         <p><span class="legende-numero">Bleu</span> : Adresses prêtes à intégrer</p>
         <p><span class="legende-numero anomalie">Rose</span> : Adresses avec anomalie identifiée</p>
     </div>
    <footer>
        <!--#include file="includes/footer.html" -->
    </footer>
    <div id="josm_target" style="visibility : hidden"></div>
    </body>
</html>