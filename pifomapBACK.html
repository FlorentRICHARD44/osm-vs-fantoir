<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pifocarte</title>
    <meta property="og:description" content="Add a GeoJSON line to a map using addSource, then style it using addLayerâ€™s paint properties." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.js'></script>
    <script src="js/jquery-3.6.4.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        .maplibregl-popup {
            max-width: 400px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    function load_map(features_orange,features_vert,features_bleu){
        const map = new maplibregl.Map({
            container: 'map',
            style:'./pifomap.style',
            center: [4.80313,45.715284],
            zoom: 15
        });

        map.on('load', () => {
            map.addSource('source_orange', {
                'type': 'geojson',
                'data': features_orange
            });
            map.addSource('source_vert', {
                'type': 'geojson',
                'data': features_vert
            });
            map.addSource('source_bleu', {
                'type': 'geojson',
                'data': features_bleu
            });

            console.log(features_bleu)

            map.addLayer({
                'id': 'layer_orange',
                'type': 'circle',
                'source': 'source_orange',
                // 'layout': {
                //     'text-field': 'nom_topo',
                //     'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                //     'text-offset': [0, 0.6],
                //     'text-anchor': 'top'
                // },
                'paint': {
                    'circle-radius': 5,
                    'circle-color': '#cc3300'
                }
            });
            map.addLayer({
                'id': 'layer_vert',
                'type': 'circle',
                'source': 'source_vert',
                // 'layout': {
                //     'text-field': 'nom_osm',
                //     'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                //     'text-offset': [0, 0.6],
                //     'text-anchor': 'top'
                // },
                'paint': {
                    'circle-radius': 5,
                    'circle-color': '#007700'
                }
            });
            map.addLayer({
                'id': 'layer_bleu',
                'type': 'circle',
                'source': 'source_bleu',
                // 'layout': {
                //     'text-field': 'nom_osm',
                //     'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                //     'text-offset': [0, 0.6],
                //     'text-anchor': 'top'
                // },
                'paint': {
                    'circle-radius': 5,
                    'circle-color': '#007cbf'
                }
            });
            def_clic(map,'layer_orange','nom_topo')
            def_clic(map,'layer_vert','nom_osm')
            def_clic(map,'layer_bleu','nom_osm')
        });
    }

    function def_clic(map,layer,nom){
        map.on('click', layer, (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const description = e.features[0].properties[nom];
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }
                new maplibregl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);
            });

            map.on('mouseenter', layer, () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            // Change it back to a pointer when it leaves.
            map.on('mouseleave', layer, () => {
                map.getCanvas().style.cursor = '';
            });
    }

    function start(){
        $.ajax({
            url: "requete_pifometre_voies.py?insee=57630&format=geojson",
            async: false
        })
        .done(function( data ) {
            let[features_orange,
                features_vert,
                features_bleu] = data
            load_map(features_orange,features_vert,features_bleu)
        })
    }

</script>
<body onload="start()">
</body>
</html>
