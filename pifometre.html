<html>
<head>
<meta charset="UTF-8">
<title>Pifomètre</title>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/tablesorter/jquery.tablesorter.js"></script>
<link rel="stylesheet" href="css/tablesorter/theme.default.min.css" type="text/css"/>
<link rel="stylesheet" href="css/style.css" type="text/css"/>
<link rel="stylesheet" href="css/style_pifometre.css" type="text/css"/>
<link rel="stylesheet" href="css/menu.css" type="text/css"/>
<link rel="search" type="application/opensearchdescription+xml" title="Pifomètre BANO" href="opensearch.xml" />
<script>
    FILTRES = [["voie"," voies",0,true],
               ["lieu_dit"," lieux-dits",0,true],
               ["nom_integre"," rapprochés",0,true],
               ["nom_a_integrer"," non rapprochés",0,true],
               ["avec_adresses"," avec adresses",0,true],
               ["sans_adresses"," sans adresses",0,true]]
    STATUS_FANTOIR = []
    DELTA = 0.0008

    function start(){
        $('#table_communes_voisines').css('visibility','hidden');
        $('#table_communes_voisines table tr td').empty()
                                                 .removeAttr('insee_cible')
                                                 .unbind('click');
        $.ajax({
            url: "labels_statut_fantoir.py"
        })
        .done(function( data ) {
            a_menus_labels = []
            for (c=0;c<data.length;c++){
                menu_labels = '<select>'
                id_label = 0
                for (i=0;i<data.length;i++){
                    if (c!=i){
                        menu_labels+='<option value='+data[i][0]+'>'+data[i][1]+'</option>'
                    } else {
                        menu_labels+='<option value='+data[i][0]+' selected>'+data[i][1]+'</option>'
                        id_label = data[i][0]
                    }
                }
                STATUS_FANTOIR.push('statut'+c)
                menu_labels+='</select>'
                a_menus_labels[id_label] = menu_labels
            }
        })
        check_josm_remote_control()
        insee = check_url_for_insee()
        if (insee){
            $('#input_insee').empty()
            $('#input_insee')[0].value = insee
            requete_pifometre()
        }
        $('#bouton_communes_voisines').click(function(){
            $('#table_communes_voisines').css('visibility','visible');
        })
        $('#table_communes_voisines > .fermer').click(function(){
            $('#table_communes_voisines').css('visibility','hidden');
        })
        update_csv_url()

        $('#bouton_refresh').click(function(){
                                refresh();
                            })
                            .mouseover(function(){
                                get_osm_state();
                                refresh_infobulle();
                            })
                            .mouseout(function(){
                                $('#refresh_infobulle').hide()
                            })
        $('#bouton_aide').click(function(){
            $('#aide').css('visibility','visible');
        })
        $('#aide > .fermer').click(function(){
            $('#aide').css('visibility','hidden');
        })
    };
    function refresh(){
        if (commune_valide == false){
            return 0;
        }
        $('body').css('cursor','progress');
        $('#wait_ajax').empty()
                       .css('z-index','20')
                       .css('opacity','0.8')
                       .append($('<span>').append('Mise à jour BANO en cours...'));
        $.ajax({
            url: "refresh.py?insee="+$('#input_insee')[0].value,
        })
        .done(function( data ){
            if (data == '1'){
                $('#wait_ajax').append($('<span>').append("Ok"));
                requete_pifometre();
            } else {
                alert('Problème lors de la mise à jour')
            }
            $('body').css('cursor','default');
            $('#wait_ajax').css('z-index','1').css('opacity','0');
        })
    }

    function update_filtres(){
        for (let i = 0; i < FILTRES.length; i++){
            FILTRES[i] = [FILTRES[i][0],FILTRES[i][1],$('#table_pifometre tr.'+FILTRES[i][0]).length,$('#check_'+FILTRES[i][0]).is(':checked')]
        }
    }
    function update_menu_filtres(){
        $('#filtres').empty()
        for (let f of FILTRES){
            $('#filtres').append($('<input>').attr('type','checkbox').attr('id','check_'+f[0]).attr('checked',true))
            $('#filtres').append($('<label>').attr('for','check_'+f[0]).text(f[1]))
        }
        $('#filtres input').click(function(){
            show_mask_lines()
        })
    };
    function show_mask_lines(){
        update_filtres()
        $('#table_pifometre tbody tr').each(function() {
           action = 'donotfilter'
           for (let f of FILTRES){
                if ($(this).hasClass(f[0]) && f[3] == false){
                    action = 'filter'
                }
                $(this).removeClass('filtered')
                if (action == 'filter'){
                    $(this).addClass('filtered')
                }
            }
       });
    }
    function add_josm_link(xl,xr,yb,yt){
        $('#table_pifometre tr:last').append($('<td>')
                                    .addClass('zone_click')
                                    .attr('xleft',xl).attr('xright',xr).attr('ybottom',yb).attr('ytop',yt)
                                    .text('JOSM')
                                    .click(function(){
                                        srcLoadAndZoom = 'http://127.0.0.1:8111/load_and_zoom?left='+xl+'&right='+xr+'&top='+yt+'&bottom='+yb;
                                        $('<img>').appendTo($('#josm_target')).attr('src',srcLoadAndZoom);
                                        $(this).addClass('clicked');
                                    })
                                )
    }
    function add_statut_fantoir(id_ligne,fantoir,id_statut){
        $('#table_pifometre tr:last').removeClass(STATUS_FANTOIR).addClass('statut'+id_statut)
        $('#table_pifometre tr:last').append($('<td>').append($(a_menus_labels[id_statut]).change(function() {
            insee = fantoir.substr(0,5);
            statut = $(this)[0].value;
            $.ajax({
                url: "statut_fantoir.py?insee="+insee+"&fantoir="+fantoir+"&statut="+statut
            })
            .done(function( data ) {
                if(data == statut){
                    $('tr#'+id_ligne).removeClass(STATUS_FANTOIR).addClass('statut'+statut)
                } else {
                    alert("Souci lors de la mise à jour du statut. Le nouveau statut n'a pas été pris en compte")
                }
            })
        })))
    }
    function add_josm_addr_link(insee,fantoir,nom_fantoir,nombre,fantoir_dans_relation,is_place){
        $('#table_pifometre tr:last').append($('<td>'))
        $('#table_pifometre tr:last td:last').append($('<span>')
                                    .addClass('zone_click')
                                    .text(nombre > 1 ? nombre+' Points':'1 Point')
                                    .click(function(){
                                        stringToRemove = window.location.href.split('/').pop()
                                        srcURL = 'http://127.0.0.1:8111/import?new_layer=true&layer_name='+nom_fantoir+'&url='+window.location.href.replace(stringToRemove,'')+'requete_numeros.py?insee='+insee+'&fantoir='+fantoir+'&modele='+((is_place) ? 'Place':'Points');
                                        $('<img>').appendTo($('#josm_target')).attr('src',srcURL);
                                        $(this).addClass('clicked');
                                    })
                                )
        if (is_place){
            $('#table_pifometre tr:last td:last').append($('<span>').text(' (lieu-dit)'))
        } else {
            $('#table_pifometre tr:last td:last').append($('<span>').text(' ou '))
            $('#table_pifometre tr:last td:last').append($('<span>')
                                        .addClass('zone_click')
                                        .text('Relation')
                                        .click(function(){
                                            stringToRemove = window.location.href.split('/').pop()
                                            srcURL = 'http://127.0.0.1:8111/import?new_layer=true&layer_name='+nom_fantoir+'&url='+window.location.href.replace(stringToRemove,'')+'requete_numeros.py?insee='+insee+'&fantoir='+fantoir+'&modele=Relation&fantoir_dans_relation='+fantoir_dans_relation;
                                            $('<img>').appendTo($('#josm_target')).attr('src',srcURL);
                                            $(this).addClass('clicked');
                                        })
                                    )
        }
    }
    function add_addr_inspector_link(insee,fantoir,source){
        $('#table_pifometre tr:last').append($('<td>').append($('<a>').attr('href',"numeros.html?insee="+insee+'&fantoir='+fantoir+'&source='+source+'&tab=0')
                                               .append('Qualifier'))
    )};
    function requete_pifometre(){
        commune_valide = false;
        $('body').css('cursor','progress');
        $('#input_insee')[0].value = $('#input_insee')[0].value.toUpperCase()
        $('#table_pifometre').empty()
        $.ajax({
            url: "requete_pifometre.py?insee="+$('#input_insee')[0].value
        })
        .done(function( pifodata ) {
            add_header()
            nom_commune = pifodata[0]
            lon_commune = pifodata[1]
            lat_commune = pifodata[2]
            a_voisins = pifodata[3]
            insee_commune_parente = pifodata[4]
            nom_commune_parente = pifodata[5]
            data = pifodata[6]

            document.title = nom_commune+' - Pifomètre'
            $('#table_infos_commune').empty()
            $('.rubrique').empty()
            $('#alerte_commune').css('visibility','hidden');

            if (nom_commune.length == 0){
                $('#table_infos_commune').append($('<h2>').append('INSEE '+$('#input_insee')[0].value+' : commune inconnue'))
                $('body').css('cursor','default');
                return 0;
            }
            commune_valide = true;

            tr_id = 1000
            for (s=0;s<data.length;s++){
                record = data[s]
                fantoir = record[0]
                date_creation = record[1]
                annule = record[2]
                nom_topo = record[3]
                nom_osm = record[4]
                nom_ban = record[5]
                lon = record[6]
                lat = record[7]
                statut_voie = record[8]
                numeros_a_proposer = record[9]
                caractere_annul = record[10]
                is_place = record[11]
                avec_adresses_ban = record[12]

                fantoir_affiche = fantoir
                fantoir_dans_relation = 'ok'
                if (caractere_annul == 'B'){
                    fantoir_affiche = 'Voie sans FANTOIR'
                    fantoir_dans_relation = 'ko'
                }

                tr_id+=1

                $('#table_pifometre tbody').append($('<tr>').attr('id',tr_id).append($('<td>').attr('fantoir',fantoir).addClass('cell_fantoir').text(fantoir)))
                // Date de creation
                $('#table_pifometre'+' tr:last').append($('<td>').text(date_creation))
                //Nom Fantoir
                $('#table_pifometre'+' tr:last').append($('<td>').text(nom_topo))
                //Nom OSM
                $('#table_pifometre'+' tr:last').append($('<td>').text(nom_osm))
                //Nom BAN
                $('#table_pifometre'+' tr:last').append($('<td>').text(nom_ban))
                xmin  = lon-DELTA
                xmax  = lon+DELTA
                ymin  = lat-DELTA
                ymax  = lat+DELTA
                //visu
//                add_map_link(table,url_map_org_part1+'#map='+url_hash_coords,'ORG')
                //JOSM
                add_josm_link(xmin,xmax,ymin,ymax)
                //Statut FANTOIR
                add_statut_fantoir(tr_id,fantoir,statut_voie)
                //Adresses à integrer
                if (numeros_a_proposer > 0){
                    add_josm_addr_link($('#input_insee')[0].value,fantoir,nom_topo,numeros_a_proposer,fantoir_dans_relation,is_place)
                } else {
                    $('#table_pifometre tr:last').append($('<td>'))
                }
                if (avec_adresses_ban){
                    add_addr_inspector_link($('#input_insee')[0].value,fantoir,'BAN')
                } else {
                    $('#table_pifometre tr:last').append($('<td>'))
                }
                //$('#table_pifometre'+' tr:last').append($('<td>').text(numeros_a_proposer))
                if (is_place){
                    $('#table_pifometre'+' tr:last').addClass('lieu_dit')
                } else {
                    $('#table_pifometre'+' tr:last').addClass('voie')
                }
                if (nom_osm == undefined) {
                    $('#table_pifometre'+' tr:last').addClass('nom_a_integrer')
                } else {
                    $('#table_pifometre'+' tr:last').addClass('nom_integre')
                } 
                if (avec_adresses_ban) {
                    $('#table_pifometre'+' tr:last').addClass('avec_adresses')
                } else {
                    $('#table_pifometre'+' tr:last').addClass('sans_adresses')
                }
            }
            $('#table_pifometre').tablesorter();
            update_menu_filtres()
            window.location.hash="#insee="+$('#input_insee')[0].value
            $('body').css('cursor','default');
        })
    };

    function add_header(){
        $('#table_pifometre').append($('<thead>').append($('<tr>').append($('<th>').append('Code FANTOIR'))))
        $('#table_pifometre'+' tr').append($('<th>').append('Création TOPO'))
        $('#table_pifometre'+' tr').append($('<th>').append('Libellé TOPO'))
        $('#table_pifometre'+' tr').append($('<th>').append('Libellé OSM'))
        $('#table_pifometre'+' tr').append($('<th>').append('Libellé BAN ou CADASTRE'))
        $('#table_pifometre'+' tr').append($('<th>').append('Edition'))
        $('#table_pifometre'+' tr').append($('<th>').append('Statut FANTOIR ').append($('<a>').attr('href','http://wiki.openstreetmap.org/wiki/Contribuer_%C3%A0_la_BANO#Typologie_des_anomalies_FANTOIR').append('(wiki)')))
        $('#table_pifometre'+' tr').append($('<th>').addClass('string-none').append('Intégrer les adresses'))
        $('#table_pifometre'+' tr').append($('<th>').append('Qualifier les adresses'))
        $('#table_pifometre').append($('<tbody>'))
    };
    function check_url_for_insee(){
        pattern_insee = new RegExp('^[0-9][0-9abAB][0-9]{3}$')
        var res
        if (window.location.hash){
            if (window.location.hash.split('insee=')[1].split('&')[0]){
                if (pattern_insee.test(window.location.hash.split('insee=')[1].split('&')[0])){
                    res = window.location.hash.split('insee=')[1].split('&')[0]
                } else {
                    alert(window.location.hash.split('insee=')[1].split('&')[0]+' n\'est pas un code INSEE de commune\n\nAbandon')
                }
            }
        }
        return res
    }
    function update_csv_url(){
        $('#bouton_export_csv').empty()
        $('#bouton_export_csv').append($('<a>').attr('href',"requete_pifometre.py?insee="+$('#input_insee')[0].value+'&format=csv')
                                               .attr('target','blank')
                                               .append($('<img>').attr('src','img/export-to-csv-icon-13.jpg')))
    }
    function check_josm_remote_control(){
        $.ajax({
            url: "http://127.0.0.1:8111/version"
        })
        .done(function(data){
            if (data){
                console.log('Telecommande JOSM OK')
            }
        })
        .fail(function(data){
            alert("La telecommande JOSM ne répond pas.\nCertains liens sur la page nécessitent que JOSM soit démarré avec la télécommande activée\n\nPour de l'aide sur la télécommande : https://josm.openstreetmap.de/wiki/Help/Preferences/RemoteControl")
        })
    }

</script>
</head>

<body onload="start()">
    <header>
        <!--#include file="includes/menu.html" -->
    </header>
    <div id="barre-jaune">
        <span>Commune :</span>
        <form action="javascript:requete_pifometre()" autocomplete="on">
            <input type="text" id="input_insee" placeholder="Code INSEE"></input>
            <input type="submit" value="Lister">
        </form>
    </div>
    <div id="bandeau">
        <div id='bandeau_commune'>
            <table id="table_infos_commune"></table>
        </div>
        <div id="refresh_infobulle"></div>
        <div id="table_communes_voisines">
            <div class="fermer">X</div>
            <table>
            <tbody>
                <tr><td id="11"></td><td id="12"></td><td id="1"></td><td id="2"></td></tr>
                <tr><td id="10"></td><td class="commune_centre" colspan="2" rowspan="2"></td><td id="3"></td></tr>
                <tr><td id="9"></td><td id="4"></td></tr>
                <tr><td id="8"></td><td id="7"></td><td id="6"></td><td id="5"></td></tr>
            </tbody>
            </table>
        </div>
        <div id="bouton_export_csv" title="Exporter l'onglet courant en CSV"></div>
        <div id="bouton_communes_voisines" title="Communes voisines"></div>
        <div id="bouton_refresh" title="Mettre à jour les données BANO"></div>
        <div id="bouton_aide" title="Aide"></div>
        <div id="infos_refresh"></div>
        <div id="alerte_commune"></div>
        <div id="aide">
            <div class="fermer">X</div>
            <h3>Statuts FANTOIR</h3>
            <li>Erreur d'orthographe</li><p>Erreur d'orthographe de FANTOIR vérifié sur le terrain ou de source officielle (documents)</p>
            <li>Divergence d'orthographe</li><p>Pas la même orthographe dans Fantoir et sur le terrain, sans qu'il soit évident de trancher.
            <li>Nom différent</li><p>Existence d'adresse dans une même rue avec des nom de rues différents, coté FANTOIR. Ce n'est ni une erreur d'orthographe, ni un doublon, mais un nom *vraiment* différent. À marquer si ce nom n'est volontairement pas retenu pour les rapprochements.
            <li>Type de voie différent</li><p>Par ex. :'Impasse XXX' dans Fantoir, et 'Ruelle XXX' sur le terrain, sans qu'il existe ailleurs dans la commune une 'Impasse XXX'
            <li>Voie doublon et type de voie différent</li><p>Par ex. : 2 entrées 'Impasse XXX' ET 'Ruelle XXX' dans Fantoir, et uniquement une 'Ruelle XXX' sur le terrain, sans qu'il existe ailleurs dans la commune d' 'Impasse XXX'. => 'Impasse XXX' à marquer en doublon.
            <li>Voie doublon avec orthographe différente</li><p>2 graphies pour un même nom dans Fantoir.
            <li>Répétition du type de voie</li><p>Type de voie (rue, petite rue...) en double avec de possibles variantes dans les abréviations. Ex: Gde Rue Grande Rue
            <li>Nom introuvable sur le terrain</li><p>Pour un nom n'entrant pas dans les autres situations (doublon...) et sans aucune trace sur le terrain
            <li>Ancien nom supprimé sur le terrain</li><p>Normalement Fantoir indique une date de fin pour un nom obsolète, et tous les enregistrements avec une date passée sont ignorés dans BANO. Si un nom Fantoir apparaît dans les listes alors qu'il a été remplacé sur le terrain, il faut le marquer.
            <li>Nom tronqué</li><p>Les noms de voie Fantoir sont limités à 26 caractères. Ça peut être une cause d'échec de rapprochement, quand le nom OSM dépasse cette longueur.
            <li>Voie détruite</li><p>La voie a bien existé mais son emprise a disparu suite à des travaux.
            <li>Voie incorporée à une autre</li><p>La voie a "fusionné" avec une autre. Son nom n'a pas été préservé.
            <li>Voie inexistante</li><p>Pas de trace de la voie sur le terrain, et pas de souvenir de son existence par le passé.
            <li>Adresses hors périmètre</li><p>C'est plus un souci de géométrie dans le Cadastre, que dans les listes Fantoir en tant que tel : lorsque certains points d'adresse sont situés à plusieurs rues du reste des adresses de la voie, sans aucune justification.
            <li>Erreurs combinées</li><p>À utiliser quand plusieurs choix sont possibles dans la liste des anomalies.
        </div>
        <div id='filtres'></div>
    </div>
    <div id="reponse">
        <table id="table_pifometre"></table>
    </div>
    <footer>
    <!--#include file="includes/footer.html" -->
    </footer>
    <div id="josm_target" style="visibility : hidden"></div>
    <div id="wait_ajax"></div>
    <div id="mask_inspect_adresse"></div>
    <div id="modal_inspect_adresse">
        <div class="fermer">X</div>
        <div id="titre_inspect_adresse"><h1>Titre</h1></div>
        <table id="table_inspect_adresse"></table>
    </div>
    <script>
        $('#modal_inspect_adresse > .fermer').click(function(){
            $('#mask_inspect_adresse').css('display','none');
            $('#modal_inspect_adresse').css('display','none');
        })
    </script>
</body>
</html>
